/ ===== SEO: Item show =====
- item_name     = @item.name.to_s
- country_param = params[:country].to_s.presence
- given_ep_cnt  = (@given_ai   || []).map { |ai| ai.appearance&.episode_id }.compact.uniq.size
- brought_ep_cnt= (@brought_ai || []).map { |ai| ai.appearance&.episode_id }.compact.uniq.size
- total_cnt     = given_ep_cnt + brought_ep_cnt
- subtitle_bits = []
- subtitle_bits << "in #{country_param}" if country_param
- subtitle_str  = subtitle_bits.any? ? " — " + subtitle_bits.join(" ") : ""

/ Title + meta
- content_for :title, "#{item_name} – Naked and Afraid Item#{subtitle_str}"
- content_for :meta_description, "#{item_name} usage across Naked & Afraid episodes#{country_param ? " in #{country_param}" : ""}: given in #{given_ep_cnt}, brought in #{brought_ep_cnt}, total #{total_cnt}. Episode lists and country breakdown."
- content_for :keywords, "#{item_name}, Naked and Afraid item, survival gear, brought items, given items#{country_param ? ", #{country_param}" : ""}"
- content_for :canonical_url, request.original_url
- content_for :og_title, "#{item_name} – Naked and Afraid Item"
- content_for :og_description, "Given in #{given_ep_cnt} episode(s), brought in #{brought_ep_cnt}; total #{total_cnt} appearances#{country_param ? " in #{country_param}" : ""}."

/ JSON for schema (helper builds JSON string; one line keeps Slim happy)
- data = item_show_json_payload(item: @item, given_ai: @given_ai, brought_ai: @brought_ai, country: country_param)
script type="application/json" id="item-jsonld-data"= data
= javascript_import_module_tag "json_ld/item_show", defer: true
/ ===== end SEO =====


.container.my-4
  / Header
  .pb-2.mb-3.border-bottom.site-header
    h1.h3.mb-0.logo = @item.name
    p.subtitle Analytics for this item across all episodes.

  / Country filter
  = form_with url: item_path(@item), method: :get, local: true, class: "card shadow-sm mb-4" do
    .card-header.d-flex.align-items-center
      span.me-2(aria-hidden="true") 🌍
      span Filter
    .card-body
      - countries = Location.where.not(country: [nil, ""]).distinct.order(:country).pluck(:country)
      .row.g-3.align-items-end
        .col-md-4
          = label_tag :country, "Country", class: "form-label"
          = select_tag :country,
              options_for_select([["All Countries", ""]] + countries.map { |c| [c, c] }, @country),
              class: "form-select"
        .col-md-auto
          = submit_tag "Apply", class: "btn btn-dark"
        .col-md-auto
          = link_to "Reset", item_path(@item), class: "btn btn-light"

  / ---------- Quick stats (dedup + adjusted) ----------
  - given_episode_ids   = @given_episode_ids   || []
  - brought_episode_ids = @brought_episode_ids || []
  - given_keys          = @given_keys          || []
  - brought_keys        = @brought_keys        || []

  .row.g-3.mb-4
    .col-md-6.col-lg-3
      .card.shadow-sm.h-100
        .card-body
          .small.text-muted.mb-1 Given in episodes 
          .display-6.fw-bold = given_episode_ids.size
          /.small.text-muted.mt-1 = "Adjusted (continuous=1): #{given_keys.size}"
    .col-md-6.col-lg-3
      .card.shadow-sm.h-100
        .card-body
          .small.text-muted.mb-1 Brought in episodes 
          .display-6.fw-bold = brought_episode_ids.size
          /.small.text-muted.mt-1 = "Adjusted (continuous=1): #{brought_keys.size}"

  / ===== Given — by episode (unique within episode) =====
  - given_by_ep = (@given_ai || []).group_by { |ai| ai.appearance.episode }
  .card.shadow-sm.mb-4
    .card-header.d-flex.align-items-center.justify-content-between
      span
        span.me-2(aria-hidden="true") 🎁
        strong Given — Episodes 
      span.badge.rounded-pill.bg-secondary-subtle.text-secondary-emphasis = given_by_ep.size
    .table-responsive
      table.table.table-sm.table-hover.mb-0
        thead.table-light
          tr
            th Episode
            th Season
            th Air Date
            th Location
            th Recipients
        tbody
          - if given_by_ep.blank?
            tr
              td.text-muted.py-4(colspan="4") No given appearances
          - else
            - given_by_ep.sort_by { |ep, _| [ep&.air_date || Date.new(1,1,1), ep&.id || 0] }.each do |ep, ais|
              - recipients = ais.map { |ai| ai.appearance.survivor.full_name }.uniq
              tr
                td = link_to(ep.title, episode_path(ep))
                td
                  - if ep&.season
                    = link_to "S#{ep.season.number} • #{ep.season.series&.name}", season_path(ep.season)
                  - else
                    | —
                td = ep.air_date || "—"
                td = [ep.location&.country, ep.location&.region, ep.location&.site].compact.join(" / ").presence || "—"
                td = recipients.join(", ")

  / ===== Brought — by episode (unique within episode) =====
  - brought_by_ep = (@brought_ai || []).group_by { |ai| ai.appearance.episode }
  .card.shadow-sm.mb-4
    .card-header.d-flex.align-items-center.justify-content-between
      span
        span.me-2(aria-hidden="true") 🧰
        strong Brought — Episodes
      span.badge.rounded-pill.bg-secondary-subtle.text-secondary-emphasis = brought_by_ep.size
    .table-responsive
      table.table.table-sm.table-hover.mb-0
        thead.table-light
          tr
            th Episode
            th Season
            th Air Date
            th Location
            th Brought by
        tbody
          - if brought_by_ep.blank?
            tr
              td.text-muted.py-4(colspan="4") No brought appearances
          - else
            - brought_by_ep.sort_by { |ep, _| [ep&.air_date || Date.new(1,1,1), ep&.id || 0] }.each do |ep, ais|
              - people = ais.map { |ai| ai.appearance.survivor.full_name }.uniq
              tr
                td = link_to(ep.title, episode_path(ep))
                td
                  - if ep&.season
                    = link_to "S#{ep.season.number} • #{ep.season.series&.name}", season_path(ep.season)
                  - else
                    | —
                td = ep.air_date || "—"
                td = [ep.location&.country, ep.location&.region, ep.location&.site].compact.join(" / ").presence || "—"
                td = people.join(", ")

  / ===== By Country (adjusted totals from controller) =====
  .card.shadow-sm
    .card-header.d-flex.align-items-center
      span.me-3.fs-3(aria-hidden="true") 🌐
      h2.h6.mb-0 By Country
    .table-responsive
      table.table.table-sm.table-hover.mb-0
        thead.table-light
          tr
            th(scope="col") Country
            th(scope="col" class="text-end") Total
        tbody
          - if @by_country.blank?
            tr
              td.text-muted.py-4(colspan="2") No data
          - else
            - @by_country.each do |r|
              tr
                td = r.country.presence || "Unknown"
                td.text-end = r.total.to_i
